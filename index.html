<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML to WordPress Blocks Converter</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding-top: 20px;
        }

        h1 {
            font-size: 28px;
            font-weight: 500;
            color: #111;
            margin-bottom: 8px;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
        }

        .version-badge {
            display: inline-block;
            background: #22c55e;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .output-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        @media (max-width: 968px) {
            .output-grid {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }

        .panel-header {
            padding: 12px 16px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fafafa;
        }

        .panel-title {
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
        }

        .panel-body {
            padding: 16px;
        }

        .options {
            margin: 20px 0;
            padding: 16px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .option-group label {
            display: flex;
            align-items: center;
            font-size: 14px;
            cursor: pointer;
            color: #4b5563;
        }

        .option-group input[type="checkbox"] {
            margin-right: 8px;
        }

        textarea {
            width: 100%;
            min-height: 300px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'SF Mono', Monaco, 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.5;
            resize: vertical;
        }

        textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .output-area {
            background: #f9fafb;
        }

        .css-area {
            background: #1e293b;
            color: #e2e8f0;
            font-size: 12px;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
            color: white;
        }

        .btn-convert {
            background: #3b82f6;
            padding: 12px 28px;
            font-size: 14px;
        }

        .btn-convert:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6b7280;
            font-size: 12px;
            padding: 6px 14px;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-copy {
            background: #10b981;
        }

        .btn-copy:hover {
            background: #059669;
        }

        .btn-clear {
            background: #ef4444;
        }

        .btn-clear:hover {
            background: #dc2626;
        }

        .sample-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .controls {
            text-align: center;
            margin: 30px 0;
        }

        .btn-group {
            display: flex;
            gap: 8px;
        }

        .stats-bar {
            background: #f3f4f6;
            padding: 10px 15px;
            border-radius: 4px;
            margin-top: 10px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            font-size: 12px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #6b7280;
        }

        .stat-value {
            font-weight: 600;
            color: #1e293b;
        }

        .message {
            padding: 10px 14px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 13px;
            display: none;
        }

        .message.show {
            display: block;
        }

        .success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #6b7280;
            font-size: 12px;
        }

        .footer-links {
            margin-top: 8px;
        }

        .footer-links a {
            color: #3b82f6;
            text-decoration: none;
            margin: 0 10px;
        }

        .footer-links a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                HTML to WordPress Blocks
                <span class="version-badge">v5.0</span>
            </h1>
            <p class="subtitle">Clean, optimized conversion with CSS separation</p>
        </header>

        <!-- Options Panel -->
        <div class="options">
            <div class="options-grid">
                <div class="option-group">
                    <label>
                        <input type="checkbox" id="separateCSS" checked>
                        Separate CSS from HTML
                    </label>
                </div>
                <div class="option-group">
                    <label>
                        <input type="checkbox" id="optimizeClasses" checked>
                        Optimize class names (wp-b1, wp-b2...)
                    </label>
                </div>
                <div class="option-group">
                    <label>
                        <input type="checkbox" id="mergeStyles" checked>
                        Merge duplicate styles
                    </label>
                </div>
                <div class="option-group">
                    <label>
                        <input type="checkbox" id="preserveMediaQueries">
                        Preserve media queries
                    </label>
                </div>
            </div>
        </div>

        <!-- Input Panel -->
        <div class="main-grid">
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">HTML Input</span>
                    <button class="btn-clear" onclick="clearAll()">Clear</button>
                </div>
                <div class="panel-body">
                    <div class="sample-buttons">
                        <button class="btn-secondary" onclick="loadSample('simple')">Simple</button>
                        <button class="btn-secondary" onclick="loadSample('styled')">Styled</button>
                        <button class="btn-secondary" onclick="loadSample('complex')">Complex</button>
                        <button class="btn-secondary" onclick="loadSample('bootstrap')">Bootstrap</button>
                    </div>
                    <textarea 
                        id="htmlInput" 
                        placeholder="Paste your HTML code here..."
                    ></textarea>
                    <div class="stats-bar">
                        <div class="stat-item">
                            <span>Input size:</span>
                            <span class="stat-value" id="inputSize">0 KB</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Convert Button -->
        <div class="controls">
            <button class="btn-convert" onclick="convertHTML()">Convert to Blocks</button>
        </div>

        <!-- Output Grid -->
        <div class="output-grid">
            <!-- WordPress Blocks Output -->
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">WordPress Blocks</span>
                    <div class="btn-group">
                        <button class="btn-copy" onclick="copyBlocks()">Copy</button>
                        <button class="btn-secondary" onclick="downloadBlocks()">Download</button>
                    </div>
                </div>
                <div class="panel-body">
                    <textarea 
                        id="blocksOutput" 
                        class="output-area"
                        placeholder="WordPress blocks will appear here..." 
                        readonly
                    ></textarea>
                    <div class="stats-bar">
                        <div class="stat-item">
                            <span>Blocks:</span>
                            <span class="stat-value" id="blockCount">0</span>
                        </div>
                        <div class="stat-item">
                            <span>Output size:</span>
                            <span class="stat-value" id="outputSize">0 KB</span>
                        </div>
                        <div class="stat-item">
                            <span>Compression:</span>
                            <span class="stat-value" id="compression">0%</span>
                        </div>
                    </div>
                    <div id="blockMessage" class="message"></div>
                </div>
            </div>

            <!-- CSS Output -->
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">Extracted CSS</span>
                    <div class="btn-group">
                        <button class="btn-copy" onclick="copyCSS()">Copy</button>
                        <button class="btn-secondary" onclick="downloadCSS()">Download</button>
                    </div>
                </div>
                <div class="panel-body">
                    <textarea 
                        id="cssOutput" 
                        class="css-area"
                        placeholder="/* Optimized CSS will appear here */" 
                        readonly
                    ></textarea>
                    <div class="stats-bar">
                        <div class="stat-item">
                            <span>Rules:</span>
                            <span class="stat-value" id="cssRuleCount">0</span>
                        </div>
                        <div class="stat-item">
                            <span>Size:</span>
                            <span class="stat-value" id="cssSize">0 KB</span>
                        </div>
                    </div>
                    <div id="cssMessage" class="message"></div>
                </div>
            </div>
        </div>

        <footer>
            <p>WordPress Block Converter â€¢ Optimized for performance and SEO</p>
            <div class="footer-links">
                <a href="#" onclick="showHelp()">Help</a>
                <a href="#" onclick="showShortcuts()">Shortcuts</a>
                <a href="https://github.com" target="_blank">GitHub</a>
            </div>
        </footer>
    </div>

    <script>
        // ========== Enhanced CSS Parser ==========
        class CSSParser {
            constructor() {
                this.rules = [];
                this.mediaQueries = new Map();
                this.keyframes = new Map();
            }
            
            parse(css) {
                css = this.removeComments(css);
                this.parseImports(css);
                css = this.parseKeyframes(css);
                css = this.parseMediaQueries(css);
                this.parseRules(css);
                
                return {
                    rules: this.rules,
                    media: this.mediaQueries,
                    keyframes: this.keyframes
                };
            }
            
            removeComments(css) {
                css = css.replace(/\/\*[\s\S]*?\*\//g, '');
                css = css.replace(/\/\/.*$/gm, '');
                return css;
            }
            
            parseImports(css) {
                const importRegex = /@import\s+(?:url\()?['"]([^'"]+)['"](?:\))?\s*;/g;
                let match;
                while ((match = importRegex.exec(css)) !== null) {
                    console.warn(`Found @import: ${match[1]} - needs manual handling`);
                }
            }
            
            parseKeyframes(css) {
                const keyframesRegex = /@(?:-webkit-|-moz-|-o-)?keyframes\s+([^\s{]+)\s*{([^{}]+(?:{[^}]*}[^{}]*)*)}/g;
                let match;
                while ((match = keyframesRegex.exec(css)) !== null) {
                    this.keyframes.set(match[1], match[0]);
                }
                return css.replace(keyframesRegex, '');
            }
            
            parseMediaQueries(css) {
                const mediaRegex = /@media\s+([^{]+)\s*{((?:[^{}]*{[^}]*})*[^{}]*)}/g;
                let match;
                while ((match = mediaRegex.exec(css)) !== null) {
                    const query = match[1].trim();
                    const content = match[2];
                    
                    if (!this.mediaQueries.has(query)) {
                        this.mediaQueries.set(query, []);
                    }
                    
                    const innerRules = this.parseRulesFromString(content);
                    this.mediaQueries.get(query).push(...innerRules);
                }
                return css.replace(mediaRegex, '');
            }
            
            parseRules(css) {
                const rules = this.parseRulesFromString(css);
                this.rules.push(...rules);
            }
            
            parseRulesFromString(css) {
                const rules = [];
                const ruleRegex = /([^{]+)\s*{\s*([^}]+)\s*}/g;
                let match;
                
                while ((match = ruleRegex.exec(css)) !== null) {
                    const selectors = this.parseSelectors(match[1]);
                    const declarations = this.parseDeclarations(match[2]);
                    
                    if (selectors.length > 0 && Object.keys(declarations).length > 0) {
                        rules.push({
                            selectors: selectors,
                            declarations: declarations,
                            specificity: this.calculateSpecificity(selectors[0]),
                            original: match[0]
                        });
                    }
                }
                
                return rules;
            }
            
            parseSelectors(selectorString) {
                return selectorString
                    .split(',')
                    .map(s => s.trim())
                    .filter(s => s.length > 0);
            }
            
            parseDeclarations(declarationString) {
                const declarations = {};
                const props = declarationString.split(';');
                
                props.forEach(prop => {
                    const colonIndex = prop.indexOf(':');
                    if (colonIndex > 0) {
                        const property = prop.substring(0, colonIndex).trim();
                        const value = prop.substring(colonIndex + 1).trim();
                        
                        if (property && value) {
                            const important = value.includes('!important');
                            const cleanValue = value.replace('!important', '').trim();
                            
                            declarations[property] = {
                                value: cleanValue,
                                important: important
                            };
                        }
                    }
                });
                
                return declarations;
            }
            
            calculateSpecificity(selector) {
                let id = 0;
                let cls = 0;
                let tag = 0;
                
                const idMatches = selector.match(/#[a-zA-Z][\w-]*/g);
                if (idMatches) id = idMatches.length;
                
                const classMatches = selector.match(/\.[a-zA-Z][\w-]*|:(?!not)[a-zA-Z-]+/g);
                if (classMatches) cls = classMatches.length;
                
                const tagMatches = selector.match(/^[a-zA-Z]+|[\s>+~][a-zA-Z]+|::?[a-zA-Z-]+/g);
                if (tagMatches) tag = tagMatches.length;
                
                return id * 100 + cls * 10 + tag;
            }
        }

        // ========== Style Optimizer ==========
        class StyleOptimizer {
            constructor() {
                this.styleGroups = new Map();
                this.duplicateStyles = new Map();
            }
            
            optimizeStyles(cssRules, options = {}) {
                if (options.mergeStyles) {
                    this.groupSimilarStyles(cssRules);
                    this.findDuplicateStyles();
                }
                
                return this.generateOptimizedClasses(options);
            }
            
            groupSimilarStyles(rules) {
                rules.forEach(rule => {
                    const styleHash = this.getStyleHash(rule.declarations);
                    
                    if (!this.styleGroups.has(styleHash)) {
                        this.styleGroups.set(styleHash, []);
                    }
                    
                    this.styleGroups.get(styleHash).push(rule);
                });
            }
            
            getStyleHash(declarations) {
                const sorted = Object.entries(declarations)
                    .sort(([a], [b]) => a.localeCompare(b))
                    .map(([prop, data]) => `${prop}:${data.value}${data.important ? '!important' : ''}`)
                    .join(';');
                
                return this.simpleHash(sorted);
            }
            
            simpleHash(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return Math.abs(hash).toString(36);
            }
            
            findDuplicateStyles() {
                this.styleGroups.forEach((rules, hash) => {
                    if (rules.length > 1) {
                        const selectors = rules.flatMap(r => r.selectors);
                        this.duplicateStyles.set(hash, {
                            selectors: [...new Set(selectors)],
                            declarations: rules[0].declarations
                        });
                    }
                });
            }
            
            generateOptimizedClasses(options) {
                const optimized = [];
                let classCounter = 0;
                
                this.styleGroups.forEach((rules, hash) => {
                    classCounter++;
                    const className = options.optimizeClasses ? `wp-b${classCounter}` : `wp-block-${hash}`;
                    
                    optimized.push({
                        className: className,
                        selectors: rules.flatMap(r => r.selectors),
                        declarations: rules[0].declarations,
                        count: rules.length
                    });
                });
                
                return optimized;
            }
        }

        // ========== Block Converter ==========
        class BlockConverter {
            constructor(options = {}) {
                this.options = {
                    separateCSS: options.separateCSS ?? true,
                    optimizeClasses: options.optimizeClasses ?? true,
                    mergeStyles: options.mergeStyles ?? true,
                    preserveMediaQueries: options.preserveMediaQueries ?? false
                };
                this.classCounter = 0;
                this.cssMap = new Map();
                this.cssParser = new CSSParser();
                this.styleOptimizer = new StyleOptimizer();
                this.stats = {
                    blocks: 0,
                    cssRules: 0,
                    originalSize: 0,
                    outputSize: 0,
                    cssSize: 0
                };
            }
            
            convert(html) {
                try {
                    // Reset
                    this.classCounter = 0;
                    this.cssMap.clear();
                    this.stats = {
                        blocks: 0,
                        cssRules: 0,
                        originalSize: html.length,
                        outputSize: 0,
                        cssSize: 0
                    };
                    
                    // Parse HTML
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    // Extract CSS
                    let extractedCSS = '';
                    if (this.options.separateCSS) {
                        extractedCSS = this.extractCSS(doc);
                    }
                    
                    // Convert elements
                    const blocks = [];
                    for (let child of doc.body.children) {
                        const block = this.elementToBlock(child);
                        if (block) {
                            blocks.push(block);
                        }
                    }
                    
                    const blockCode = blocks.join('\n\n');
                    this.stats.outputSize = blockCode.length;
                    
                    // Generate optimized CSS
                    let finalCSS = '';
                    if (this.options.separateCSS && (extractedCSS || this.cssMap.size > 0)) {
                        finalCSS = this.generateOptimizedCSS(extractedCSS);
                        this.stats.cssSize = finalCSS.length;
                    }
                    
                    return {
                        blocks: blockCode,
                        css: finalCSS,
                        stats: this.stats
                    };
                    
                } catch (error) {
                    console.error('Conversion error:', error);
                    throw new Error('Conversion failed: ' + error.message);
                }
            }
            
            extractCSS(doc) {
                let css = '';
                const styleTags = doc.querySelectorAll('style');
                styleTags.forEach(tag => {
                    css += tag.textContent + '\n';
                    tag.remove();
                });
                
                // Extract linked stylesheets
                const linkTags = doc.querySelectorAll('link[rel="stylesheet"]');
                linkTags.forEach(link => {
                    console.warn(`External stylesheet found: ${link.href}`);
                    link.remove();
                });
                
                return css;
            }
            
            processElementStyles(element) {
                if (!this.options.separateCSS) {
                    return element.getAttribute('style') || '';
                }
                
                const inlineStyle = element.getAttribute('style');
                const className = element.className;
                
                if (!inlineStyle && !className) {
                    return '';
                }
                
                if (this.options.optimizeClasses) {
                    const newClassName = this.generateClassName();
                    
                    if (inlineStyle) {
                        this.cssMap.set(newClassName, this.optimizeStyles(inlineStyle));
                        element.removeAttribute('style');
                    }
                    
                    return newClassName;
                }
                
                return className;
            }
            
            generateClassName() {
                this.classCounter++;
                return `wp-b${this.classCounter}`;
            }
            
            optimizeStyles(styles) {
                return styles
                    .replace(/\s+/g, ' ')
                    .replace(/;\s*;/g, ';')
                    .replace(/;\s*$/g, '')
                    .trim();
            }
            
            elementToBlock(element) {
                const tagName = element.tagName.toLowerCase();
                const className = this.processElementStyles(element);
                
                this.stats.blocks++;
                
                switch(tagName) {
                    case 'h1':
                    case 'h2':
                    case 'h3':
                    case 'h4':
                    case 'h5':
                    case 'h6':
                        return this.headingBlock(element, className);
                    case 'p':
                        return this.paragraphBlock(element, className);
                    case 'div':
                    case 'section':
                    case 'article':
                        return this.groupBlock(element, className);
                    case 'img':
                    case 'figure':
                        return this.imageBlock(element, className);
                    case 'ul':
                    case 'ol':
                        return this.listBlock(element, className);
                    case 'blockquote':
                        return this.quoteBlock(element, className);
                    case 'table':
                        return this.tableBlock(element, className);
                    case 'button':
                    case 'a':
                        if (this.isButton(element)) {
                            return this.buttonBlock(element, className);
                        }
                        return this.htmlBlock(element);
                    case 'hr':
                        return this.separatorBlock();
                    default:
                        return this.htmlBlock(element);
                }
            }
            
            headingBlock(element, className) {
                const level = parseInt(element.tagName[1]);
                const content = element.innerHTML;
                
                const attrs = { level: level };
                if (className) attrs.className = className;
                
                const attrString = this.formatAttributes(attrs);
                const classAttr = className ? ` class="${className}"` : '';
                
                return `<!-- wp:heading${attrString} -->
<h${level}${classAttr}>${content}</h${level}>
<!-- /wp:heading -->`;
            }
            
            paragraphBlock(element, className) {
                const content = element.innerHTML;
                
                const attrs = {};
                if (className) attrs.className = className;
                
                const attrString = this.formatAttributes(attrs);
                const classAttr = className ? ` class="${className}"` : '';
                
                return `<!-- wp:paragraph${attrString} -->
<p${classAttr}>${content}</p>
<!-- /wp:paragraph -->`;
            }
            
            groupBlock(element, className) {
                const tagName = element.tagName.toLowerCase();
                
                if (this.isColumnsStructure(element)) {
                    return this.columnsBlock(element);
                }
                
                const innerBlocks = [];
                for (let child of element.children) {
                    const childBlock = this.elementToBlock(child);
                    if (childBlock) {
                        innerBlocks.push(childBlock);
                    }
                }
                
                const attrs = {};
                if (tagName !== 'div') attrs.tagName = tagName;
                if (className) attrs.className = className;
                
                const attrString = this.formatAttributes(attrs);
                const classAttr = className ? ` class="${className}"` : '';
                
                const content = innerBlocks.join('\n\n') || element.innerHTML;
                
                return `<!-- wp:group${attrString} -->
<div${classAttr}>${content}</div>
<!-- /wp:group -->`;
            }
            
            imageBlock(element, className) {
                let img = element;
                if (element.tagName.toLowerCase() === 'figure') {
                    img = element.querySelector('img');
                }
                
                if (!img) return '';
                
                const src = img.src || '';
                const alt = img.alt || '';
                const width = img.width || '';
                const height = img.height || '';
                
                const attrs = {};
                if (className) attrs.className = className;
                if (width) attrs.width = width;
                if (height) attrs.height = height;
                
                const attrString = this.formatAttributes(attrs);
                const classAttr = className ? ` ${className}` : '';
                
                return `<!-- wp:image${attrString} -->
<figure class="wp-block-image${classAttr}"><img src="${src}" alt="${alt}"${width ? ` width="${width}"` : ''}${height ? ` height="${height}"` : ''}/></figure>
<!-- /wp:image -->`;
            }
            
            listBlock(element, className) {
                const isOrdered = element.tagName.toLowerCase() === 'ol';
                const attrs = {};
                if (isOrdered) attrs.ordered = true;
                if (className) attrs.className = className;
                
                const attrString = this.formatAttributes(attrs);
                const tagName = isOrdered ? 'ol' : 'ul';
                const classAttr = className ? ` class="${className}"` : '';
                
                return `<!-- wp:list${attrString} -->
<${tagName}${classAttr}>${element.innerHTML}</${tagName}>
<!-- /wp:list -->`;
            }
            
            quoteBlock(element, className) {
                const attrs = {};
                if (className) attrs.className = className;
                
                const attrString = this.formatAttributes(attrs);
                const classAttr = className ? ` ${className}` : '';
                
                return `<!-- wp:quote${attrString} -->
<blockquote class="wp-block-quote${classAttr}">${element.innerHTML}</blockquote>
<!-- /wp:quote -->`;
            }
            
            tableBlock(element, className) {
                const attrs = {};
                if (className) attrs.className = className;
                
                const attrString = this.formatAttributes(attrs);
                const classAttr = className ? ` ${className}` : '';
                
                return `<!-- wp:table${attrString} -->
<figure class="wp-block-table${classAttr}"><table>${element.innerHTML}</table></figure>
<!-- /wp:table -->`;
            }
            
            buttonBlock(element, className) {
                const text = element.textContent;
                const href = element.href || '#';
                
                const attrs = {};
                if (className) attrs.className = className;
                
                const attrString = this.formatAttributes(attrs);
                const classAttr = className ? ` ${className}` : '';
                
                return `<!-- wp:buttons -->
<div class="wp-block-buttons"><!-- wp:button${attrString} -->
<div class="wp-block-button${classAttr}"><a class="wp-block-button__link wp-element-button" href="${href}">${text}</a></div>
<!-- /wp:button --></div>
<!-- /wp:buttons -->`;
            }
            
            separatorBlock() {
                return `<!-- wp:separator -->
<hr class="wp-block-separator has-alpha-channel-opacity"/>
<!-- /wp:separator -->`;
            }
            
            htmlBlock(element) {
                return `<!-- wp:html -->
${element.outerHTML}
<!-- /wp:html -->`;
            }
            
            columnsBlock(element) {
                const columns = [];
                
                for (let child of element.children) {
                    const className = this.processElementStyles(child);
                    columns.push(this.columnBlock(child, className));
                }
                
                return `<!-- wp:columns -->
<div class="wp-block-columns">${columns.join('')}</div>
<!-- /wp:columns -->`;
            }
            
            columnBlock(element, className) {
                const innerBlocks = [];
                for (let child of element.children) {
                    const childBlock = this.elementToBlock(child);
                    if (childBlock) {
                        innerBlocks.push(childBlock);
                    }
                }
                
                const attrs = {};
                if (className) attrs.className = className;
                
                const attrString = this.formatAttributes(attrs);
                const classAttr = className ? ` ${className}` : '';
                const content = innerBlocks.join('\n\n') || element.innerHTML;
                
                return `<!-- wp:column${attrString} -->
<div class="wp-block-column${classAttr}">${content}</div>
<!-- /wp:column -->`;
            }
            
            isColumnsStructure(element) {
                const className = element.className ? element.className.toLowerCase() : '';
                const style = element.getAttribute('style') || '';
                
                return className.includes('row') || 
                       className.includes('columns') || 
                       className.includes('grid') ||
                       className.includes('flex') ||
                       style.includes('display: flex') ||
                       style.includes('display: grid');
            }
            
            isButton(element) {
                const tagName = element.tagName.toLowerCase();
                const className = element.className ? element.className.toLowerCase() : '';
                
                return tagName === 'button' || 
                       (tagName === 'a' && (className.includes('btn') || className.includes('button')));
            }
            
            formatAttributes(attrs) {
                if (!attrs || Object.keys(attrs).length === 0) {
                    return '';
                }
                
                const cleaned = {};
                for (let [key, value] of Object.entries(attrs)) {
                    if (value !== null && value !== undefined && value !== '' && value !== false) {
                        cleaned[key] = value;
                    }
                }
                
                if (Object.keys(cleaned).length === 0) {
                    return '';
                }
                
                return ' ' + JSON.stringify(cleaned);
            }
            
            generateOptimizedCSS(extractedCSS) {
                let css = '/* WordPress Block Styles - Optimized */\n';
                css += '/* Generated by HTML to WordPress Block Converter v5.0 */\n\n';
                
                // Parse and optimize extracted CSS
                if (extractedCSS && this.options.mergeStyles) {
                    const parsed = this.cssParser.parse(extractedCSS);
                    
                    // Optimize regular rules
                    if (parsed.rules.length > 0) {
                        const optimized = this.styleOptimizer.optimizeStyles(parsed.rules, this.options);
                        
                        optimized.forEach(rule => {
                            css += `.${rule.className} {\n`;
                            Object.entries(rule.declarations).forEach(([prop, data]) => {
                                css += `  ${prop}: ${data.value}${data.important ? ' !important' : ''};\n`;
                            });
                            css += '}\n\n';
                            this.stats.cssRules++;
                        });
                    }
                    
                    // Add media queries if preserved
                    if (this.options.preserveMediaQueries && parsed.media.size > 0) {
                        css += '/* Media Queries */\n\n';
                        parsed.media.forEach((rules, query) => {
                            css += `@media ${query} {\n`;
                            rules.forEach(rule => {
                                rule.selectors.forEach(selector => {
                                    css += `  ${selector} {\n`;
                                    Object.entries(rule.declarations).forEach(([prop, data]) => {
                                        css += `    ${prop}: ${data.value}${data.important ? ' !important' : ''};\n`;
                                    });
                                    css += `  }\n`;
                                });
                            });
                            css += '}\n\n';
                        });
                    }
                } else if (extractedCSS) {
                    css += extractedCSS + '\n';
                }
                
                // Add inline styles
                if (this.cssMap.size > 0) {
                    css += '/* Inline Styles */\n\n';
                    this.cssMap.forEach((styles, className) => {
                        css += `.${className} { ${styles} }\n`;
                        this.stats.cssRules++;
                    });
                }
                
                return css.trim();
            }
        }

        // ========== Main Functions ==========
        function convertHTML() {
            const input = document.getElementById('htmlInput').value;
            
            if (!input.trim()) {
                showMessage('blockMessage', 'Please enter HTML code', 'error');
                return;
            }
            
            try {
                const options = {
                    separateCSS: document.getElementById('separateCSS').checked,
                    optimizeClasses: document.getElementById('optimizeClasses').checked,
                    mergeStyles: document.getElementById('mergeStyles').checked,
                    preserveMediaQueries: document.getElementById('preserveMediaQueries').checked
                };
                
                const converter = new BlockConverter(options);
                const result = converter.convert(input);
                
                // Display results
                document.getElementById('blocksOutput').value = result.blocks;
                document.getElementById('cssOutput').value = result.css;
                
                // Update stats
                updateStats(result.stats);
                
                showMessage('blockMessage', 'Conversion successful!', 'success');
                
                if (result.css) {
                    showMessage('cssMessage', 'CSS optimized and extracted', 'success');
                }
                
            } catch (error) {
                console.error('Conversion error:', error);
                showMessage('blockMessage', 'Conversion failed: ' + error.message, 'error');
            }
        }
        
        function updateStats(stats) {
            const inputSize = (stats.originalSize / 1024).toFixed(2);
            const outputSize = (stats.outputSize / 1024).toFixed(2);
            const cssSize = (stats.cssSize / 1024).toFixed(2);
            const compression = stats.originalSize > 0 
                ? ((1 - (stats.outputSize + stats.cssSize) / stats.originalSize) * 100).toFixed(1)
                : '0';
            
            document.getElementById('inputSize').textContent = `${inputSize} KB`;
            document.getElementById('blockCount').textContent = stats.blocks;
            document.getElementById('outputSize').textContent = `${outputSize} KB`;
            document.getElementById('cssRuleCount').textContent = stats.cssRules;
            document.getElementById('cssSize').textContent = `${cssSize} KB`;
            document.getElementById('compression').textContent = `${compression}%`;
        }
        
        function clearAll() {
            document.getElementById('htmlInput').value = '';
            document.getElementById('blocksOutput').value = '';
            document.getElementById('cssOutput').value = '';
            
            // Reset stats
            document.getElementById('inputSize').textContent = '0 KB';
            document.getElementById('blockCount').textContent = '0';
            document.getElementById('outputSize').textContent = '0 KB';
            document.getElementById('cssRuleCount').textContent = '0';
            document.getElementById('cssSize').textContent = '0 KB';
            document.getElementById('compression').textContent = '0%';
            
            hideMessages();
        }
        
        function copyBlocks() {
            copyToClipboard('blocksOutput', 'blockMessage', 'Blocks copied to clipboard');
        }
        
        function copyCSS() {
            copyToClipboard('cssOutput', 'cssMessage', 'CSS copied to clipboard');
        }
        
        function copyToClipboard(elementId, messageId, successText) {
            const element = document.getElementById(elementId);
            if (!element.value) {
                showMessage(messageId, 'Nothing to copy', 'error');
                return;
            }
            
            element.select();
            element.setSelectionRange(0, 99999);
            
            try {
                document.execCommand('copy');
                showMessage(messageId, successText, 'success');
            } catch (err) {
                showMessage(messageId, 'Copy failed', 'error');
            }
        }
        
        function downloadBlocks() {
            const content = document.getElementById('blocksOutput').value;
            if (!content) {
                showMessage('blockMessage', 'No blocks to download', 'error');
                return;
            }
            download('wordpress-blocks.txt', content);
        }
        
        function downloadCSS() {
            const content = document.getElementById('cssOutput').value;
            if (!content) {
                showMessage('cssMessage', 'No CSS to download', 'error');
                return;
            }
            download('wordpress-blocks.css', content);
        }
        
        function download(filename, content) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function showMessage(elementId, text, type) {
            const element = document.getElementById(elementId);
            element.textContent = text;
            element.className = `message show ${type}`;
            
            setTimeout(() => hideMessages(), 3000);
        }
        
        function hideMessages() {
            document.querySelectorAll('.message').forEach(el => {
                el.className = 'message';
            });
        }
        
        function showHelp() {
            alert(`How to use:
1. Paste your HTML code in the input area
2. Configure options (CSS separation, optimization, etc.)
3. Click "Convert to Blocks"
4. Copy the WordPress blocks to your editor
5. Add the CSS to your theme or Customizer

Tips:
- Use Ctrl+Shift+Alt+M in WordPress editor to switch to code view
- Add CSS to Appearance > Customize > Additional CSS`);
        }
        
        function showShortcuts() {
            alert(`Keyboard Shortcuts:
- Ctrl+Enter: Convert
- Ctrl+Shift+C: Copy blocks
- Ctrl+Shift+S: Copy CSS
- Ctrl+Shift+D: Download blocks
- Escape: Clear messages`);
        }
        
        function loadSample(type) {
            const samples = {
                simple: `<h1>Welcome to My Website</h1>
<p>This is a simple paragraph with basic text content.</p>
<img src="https://via.placeholder.com/600x400" alt="Sample image">`,

                styled: `<style>
.hero-section {
    background: #1e293b;
    padding: 60px 20px;
    text-align: center;
}
.hero-title {
    color: white;
    font-size: 3rem;
    margin-bottom: 20px;
}
.hero-text {
    color: #e2e8f0;
    font-size: 1.2rem;
    max-width: 600px;
    margin: 0 auto;
}
</style>

<div class="hero-section">
    <h1 class="hero-title">Innovative Solutions</h1>
    <p class="hero-text">Building the future with cutting-edge technology and creative design.</p>
</div>`,

                complex: `<style>
.services { max-width: 1200px; margin: 0 auto; padding: 40px 20px; }
.services-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; }
.service-card { background: #f8f9fa; padding: 30px; border-radius: 8px; transition: transform 0.3s; }
.service-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
.service-icon { width: 60px; height: 60px; background: #3b82f6; border-radius: 50%; margin-bottom: 20px; }
.service-title { font-size: 1.5rem; margin-bottom: 15px; color: #1e293b; }
.service-description { color: #64748b; line-height: 1.6; }
.btn-primary { display: inline-block; margin-top: 15px; padding: 10px 20px; background: #3b82f6; color: white; text-decoration: none; border-radius: 5px; }
.btn-primary:hover { background: #2563eb; }
</style>

<section class="services">
    <h2 style="text-align: center; margin-bottom: 50px; font-size: 2.5rem;">Our Services</h2>
    <div class="services-grid">
        <div class="service-card">
            <div class="service-icon"></div>
            <h3 class="service-title">Web Design</h3>
            <p class="service-description">Create stunning websites that capture your brand essence and engage your audience.</p>
            <a href="#" class="btn-primary">Learn More</a>
        </div>
        <div class="service-card">
            <div class="service-icon"></div>
            <h3 class="service-title">Digital Marketing</h3>
            <p class="service-description">Boost your online presence with comprehensive digital marketing strategies.</p>
            <a href="#" class="btn-primary">Learn More</a>
        </div>
        <div class="service-card">
            <div class="service-icon"></div>
            <h3 class="service-title">App Development</h3>
            <p class="service-description">Build powerful mobile applications that deliver exceptional user experiences.</p>
            <a href="#" class="btn-primary">Learn More</a>
        </div>
    </div>
</section>`,

                bootstrap: `<div class="container">
    <div class="row">
        <div class="col-md-8">
            <h2 class="mb-4">Main Content</h2>
            <p class="lead">This is a Bootstrap-based layout example.</p>
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">Card Title</h5>
                    <p class="card-text">Some quick example text to build on the card title.</p>
                    <a href="#" class="btn btn-primary">Go somewhere</a>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <h3 class="mb-3">Sidebar</h3>
            <ul class="list-group">
                <li class="list-group-item">First item</li>
                <li class="list-group-item">Second item</li>
                <li class="list-group-item">Third item</li>
            </ul>
        </div>
    </div>
</div>`
            };
            
            document.getElementById('htmlInput').value = samples[type] || '';
            updateInputStats();
        }
        
        function updateInputStats() {
            const input = document.getElementById('htmlInput').value;
            const size = (input.length / 1024).toFixed(2);
            document.getElementById('inputSize').textContent = `${size} KB`;
        }
        
        // Event listeners
        document.getElementById('htmlInput').addEventListener('input', updateInputStats);
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                convertHTML();
            } else if (e.ctrlKey && e.shiftKey && e.key === 'C') {
                e.preventDefault();
                copyBlocks();
            } else if (e.ctrlKey && e.shiftKey && e.key === 'S') {
                e.preventDefault();
                copyCSS();
            } else if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                e.preventDefault();
                downloadBlocks();
            } else if (e.key === 'Escape') {
                hideMessages();
            }
        });
        
        // Load default sample on page load
        window.onload = function() {
            loadSample('styled');
        };
    </script>
</body>
</html>
